#!/bin/sh

ZET_DIR=$HOME/wiki

case "$1" in
    ls) 
        if [ -z "$2" ]; then
            fd -t f -e md '.*' "${ZET_DIR}"
        else
            shift 1
            rg --no-ignore --files-with-matches "$@" "${ZET_DIR}" \
                | fzf --preview="cat -n {} | grep --color=always -C 3 '$@'" --bind 'enter:execute(nvim {})'
        fi
        ;;

    new)
        f="${ZET_DIR}/$(date +%Y)/$2"
        if [ -z "$f" ]; then
            f="$(fzf --prompt="filename?> " --print-query)"
        fi
        if [ ! -f "$f" ]; then
            {
                echo "---";
                yq n date "$(date -Iseconds)";
                echo "---";
                echo "";
            } >> "$f"
        fi
        nvim "$f"
        ;;

    *) nvim "+Zet $*" ;;
esac
